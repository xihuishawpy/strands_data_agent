# ChatBI 主应用认证集成使用指南

## 概述

ChatBI 主应用现已完全集成用户认证和权限管理功能。用户需要登录后才能进行数据查询，系统会根据用户权限自动过滤可访问的数据。

## 功能特性

### 🔐 认证功能
- **用户登录/登出**: 支持工号密码登录
- **用户注册**: 新用户可以自助注册账户
- **会话管理**: 自动管理用户会话状态
- **权限验证**: 实时验证用户访问权限

### 📊 权限管理
- **数据库权限过滤**: 根据用户权限过滤可访问的数据库Schema
- **查询权限检查**: 每次查询前验证用户权限
- **审计日志**: 记录用户操作和查询历史

### 🤖 智能查询
- **认证包装器**: 使用认证包装器执行查询
- **权限感知**: 查询结果显示用户可访问的Schema信息
- **个性化反馈**: 反馈记录包含用户身份信息

## 启动应用

### 方法1: 使用专用启动脚本（推荐）

```bash
python start_chatbi_with_auth.py
```

这个脚本会：
- 自动初始化认证系统
- 运行数据库迁移
- 验证配置正确性
- 启动带认证功能的应用

### 方法2: 直接启动主应用

```bash
python gradio_app_chat.py
```

注意：如果认证系统配置不正确，应用会以降级模式运行（无认证功能）。

## 界面说明

### 1. 用户认证标签页 🔐

#### 登录区域
- **工号**: 输入您的员工工号
- **密码**: 输入登录密码
- **登录按钮**: 点击进行身份验证
- **登出按钮**: 登录成功后显示，点击退出登录

#### 注册区域
- **工号**: 设置您的员工工号（唯一标识）
- **密码**: 设置登录密码
- **确认密码**: 再次输入密码确认
- **邮箱**: 可选，用于找回密码等功能
- **姓名**: 可选，显示用的真实姓名

### 2. 智能查询标签页 💬

#### 查询界面
- **聊天窗口**: 显示查询对话历史
- **输入框**: 输入自然语言查询问题
- **发送按钮**: 提交查询请求

#### 查询选项
- **自动生成可视化**: 自动为查询结果生成图表
- **启用数据分析**: 对查询结果进行智能分析
- **分析级别**: 选择分析的详细程度（basic/standard/detailed）

#### 可视化区域
- **图表显示**: 自动生成的数据可视化图表
- **反馈功能**: 对查询结果进行点赞反馈

### 3. 系统信息标签页 ℹ️

#### 系统状态
- **测试数据库连接**: 测试当前用户的数据库访问权限
- **刷新Schema缓存**: 刷新数据库结构缓存
- **获取Schema信息**: 查看用户可访问的数据库结构

#### 知识库信息
- **获取知识库统计**: 查看SQL知识库的统计信息
- **用户权限说明**: 显示当前用户的权限范围

## 使用流程

### 1. 首次使用

1. **访问应用**: 打开浏览器访问 `http://localhost:7860`
2. **注册账户**: 在"用户认证"标签页注册新账户
3. **等待审核**: 管理员可能需要为您分配数据库访问权限
4. **开始查询**: 登录后即可在"智能查询"标签页进行数据查询

### 2. 日常使用

1. **登录系统**: 使用工号和密码登录
2. **查看权限**: 在系统信息中确认您的数据访问权限
3. **执行查询**: 输入自然语言问题进行数据查询
4. **查看结果**: 系统会显示您有权限访问的数据
5. **提供反馈**: 对满意的查询结果点赞，帮助改进系统

## 权限说明

### 数据访问权限
- **Schema级权限**: 用户只能访问被授权的数据库Schema
- **自动过滤**: 系统自动过滤用户无权访问的数据
- **权限提示**: 查询结果会显示用户的权限范围

### 功能权限
- **查询权限**: 所有登录用户都可以进行数据查询
- **反馈权限**: 登录用户可以对查询结果提供反馈
- **管理权限**: 只有管理员可以管理用户和权限

## 安全特性

### 认证安全
- **密码加密**: 用户密码使用安全哈希算法加密存储
- **会话管理**: 自动管理用户会话，支持超时和主动登出
- **权限验证**: 每次操作都会验证用户权限

### 数据安全
- **权限过滤**: 查询结果自动过滤用户无权访问的数据
- **审计日志**: 记录所有用户操作，便于安全审计
- **SQL注入防护**: 使用参数化查询防止SQL注入攻击

## 故障排除

### 常见问题

#### 1. 登录失败
- **检查工号密码**: 确认输入的工号和密码正确
- **联系管理员**: 可能需要管理员激活账户
- **检查网络**: 确认网络连接正常

#### 2. 查询无结果
- **检查权限**: 可能没有访问相关数据的权限
- **联系管理员**: 请求分配必要的数据访问权限
- **调整查询**: 尝试查询其他您有权限的数据

#### 3. 系统初始化失败
- **检查配置**: 确认认证系统配置正确
- **数据库连接**: 确认认证数据库可以正常连接
- **运行迁移**: 使用 `python -m chatbi.auth.cli migrate` 初始化数据库

### 错误代码

- **AUTH_001**: 认证系统未初始化
- **AUTH_002**: 用户名或密码错误
- **AUTH_003**: 用户账户已被禁用
- **PERM_001**: 权限不足，无法访问数据
- **PERM_002**: 会话已过期，请重新登录

## 管理员功能

管理员可以使用专门的管理界面进行用户和权限管理：

```bash
python start_admin_app.py
```

管理功能包括：
- 用户管理（创建、禁用、删除用户）
- 权限管理（分配、撤销数据库访问权限）
- 审计日志查看
- 系统配置管理

## 技术架构

### 认证流程
1. **用户登录** → **身份验证** → **创建会话** → **生成令牌**
2. **查询请求** → **会话验证** → **权限检查** → **执行查询** → **结果过滤**

### 权限模型
- **用户(User)** ← 拥有 → **权限(Permission)** ← 关联 → **Schema**
- **会话(Session)** ← 绑定 → **用户(User)**
- **查询(Query)** ← 执行于 → **会话(Session)**

### 集成组件
- **认证包装器**: 包装原始ChatBI组件，添加权限检查
- **权限过滤器**: 过滤用户无权访问的数据库对象
- **审计日志**: 记录用户操作历史

## 开发和扩展

### 添加新的权限类型
1. 在 `models.py` 中定义新的权限模型
2. 在 `permission_manager.py` 中添加权限检查逻辑
3. 在 `database_permission_filter.py` 中实现过滤逻辑

### 集成新的认证方式
1. 实现新的认证提供者
2. 在 `user_manager.py` 中添加认证逻辑
3. 更新前端界面支持新的认证方式

## 支持和反馈

如果您在使用过程中遇到问题或有改进建议，请：

1. **查看日志**: 检查应用日志获取详细错误信息
2. **联系管理员**: 报告权限相关问题
3. **提交反馈**: 通过应用内反馈功能提供建议
4. **技术支持**: 联系开发团队获取技术支持

---

**版本**: 1.0  
**更新日期**: 2024年1月  
**维护团队**: ChatBI开发团队