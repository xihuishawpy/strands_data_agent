# 需求文档

## 介绍

本功能旨在为ChatBI系统添加用户认证和权限管理模块，实现基于工号的用户注册控制和数据库访问权限管理。系统将支持管理员配置允许注册的工号列表，并为不同用户分配不同的数据库schema访问权限，确保数据安全和访问控制。

## 需求

### 需求 1 - 用户注册管理

**用户故事：** 作为系统管理员，我希望能够控制哪些工号可以注册系统，以便确保只有授权人员能够访问ChatBI系统。

#### 验收标准

1. WHEN 用户尝试注册时 THEN 系统 SHALL 验证其工号是否在允许注册的工号列表中
2. IF 工号不在允许列表中 THEN 系统 SHALL 拒绝注册并显示相应错误信息
3. WHEN 管理员更新允许注册的工号列表时 THEN 系统 SHALL 立即生效新的配置
4. WHEN 用户提供有效工号进行注册时 THEN 系统 SHALL 创建用户账户并分配默认权限

### 需求 2 - 用户登录认证

**用户故事：** 作为已注册用户，我希望能够使用工号和密码登录系统，以便安全地访问ChatBI功能。

#### 验收标准

1. WHEN 用户输入正确的工号和密码时 THEN 系统 SHALL 验证身份并创建会话
2. IF 登录凭据无效 THEN 系统 SHALL 拒绝访问并显示错误信息
3. WHEN 用户成功登录时 THEN 系统 SHALL 记录登录时间和IP地址
4. WHEN 用户会话过期时 THEN 系统 SHALL 要求重新登录
5. WHEN 用户主动登出时 THEN 系统 SHALL 清除会话信息

### 需求 3 - 数据库权限配置

**用户故事：** 作为系统管理员，我希望能够为不同用户配置不同的数据库schema访问权限，以便实现数据隔离和安全控制。

#### 验收标准

1. WHEN 管理员为用户分配schema权限时 THEN 系统 SHALL 记录用户与schema的映射关系
2. WHEN 用户执行SQL查询时 THEN 系统 SHALL 验证用户是否有权访问目标schema
3. IF 用户尝试访问未授权的schema THEN 系统 SHALL 拒绝查询并返回权限错误
4. WHEN 用户查询数据时 THEN 系统 SHALL 只返回其有权限访问的schema中的数据
5. WHEN 管理员修改用户权限时 THEN 系统 SHALL 立即更新权限配置

### 需求 4 - 权限管理界面

**用户故事：** 作为系统管理员，我希望有一个管理界面来配置用户权限和允许注册的工号，以便方便地进行权限管理。

#### 验收标准

1. WHEN 管理员访问权限管理界面时 THEN 系统 SHALL 显示所有用户及其权限信息
2. WHEN 管理员添加或删除允许注册的工号时 THEN 系统 SHALL 更新配置并保存
3. WHEN 管理员修改用户的schema权限时 THEN 系统 SHALL 更新权限配置
4. WHEN 管理员查看用户列表时 THEN 系统 SHALL 显示用户工号、注册时间和当前权限
5. WHEN 管理员删除用户时 THEN 系统 SHALL 移除用户账户和相关权限

### 需求 5 - 会话管理和安全

**用户故事：** 作为系统用户，我希望系统能够安全地管理我的登录会话，以便保护我的账户安全。

#### 验收标准

1. WHEN 用户登录时 THEN 系统 SHALL 生成安全的会话令牌
2. WHEN 用户在不同设备登录时 THEN 系统 SHALL 支持多会话管理
3. IF 会话令牌被篡改 THEN 系统 SHALL 拒绝访问并要求重新登录
4. WHEN 用户长时间不活动时 THEN 系统 SHALL 自动过期会话
5. WHEN 检测到异常登录行为时 THEN 系统 SHALL 记录安全日志

### 需求 6 - 与现有ChatBI系统集成

**用户故事：** 作为ChatBI用户，我希望认证模块能够无缝集成到现有系统中，以便不影响现有功能的使用。

#### 验收标准

1. WHEN 未登录用户访问ChatBI功能时 THEN 系统 SHALL 重定向到登录页面
2. WHEN 已登录用户使用ChatBI功能时 THEN 系统 SHALL 根据其权限过滤可访问的数据源
3. WHEN 用户执行SQL查询时 THEN 系统 SHALL 自动添加schema权限限制
4. WHEN 系统生成SQL时 THEN 系统 SHALL 只使用用户有权限的schema中的表
5. WHEN 用户查看数据库连接配置时 THEN 系统 SHALL 只显示其有权限的schema信息