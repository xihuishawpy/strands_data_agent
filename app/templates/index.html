<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBI - æ™ºèƒ½æ•°æ®æŸ¥è¯¢åº”ç”¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #fafafa;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.user {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: auto;
        }

        .input-section {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: inline-block;
        }

        .result-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .sql-code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }

        .data-table {
            overflow-x: auto;
            margin: 1rem 0;
        }

        .chart-container {
            margin: 1rem 0;
            text-align: center;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-healthy { background-color: var(--success-color); }
        .status-warning { background-color: var(--warning-color); }
        .status-error { background-color: var(--danger-color); }

        .example-queries {
            margin-top: 1rem;
        }

        .example-query {
            background: #e0f2fe;
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .example-query:hover {
            background: #b3e5fc;
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 1rem;
                border-radius: 10px;
            }
            
            .message {
                max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line me-2"></i>ChatBI - æ™ºèƒ½æ•°æ®æŸ¥è¯¢
            </span>
            <div class="d-flex">
                <button class="btn btn-outline-light me-2" onclick="showSystemStatus()">
                    <i class="fas fa-info-circle"></i> ç³»ç»ŸçŠ¶æ€
                </button>
                <button class="btn btn-outline-light" onclick="showDocs()">
                    <i class="fas fa-book"></i> APIæ–‡æ¡£
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ä¾§è¾¹æ  -->
            <div class="col-md-3">
                <div class="sidebar">
                    <h5><i class="fas fa-lightbulb text-warning"></i> æŸ¥è¯¢ç¤ºä¾‹</h5>
                    <div class="example-queries">
                        <div class="example-query" onclick="setQuery('æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯')">
                            æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
                        </div>
                        <div class="example-query" onclick="setQuery('ç»Ÿè®¡æ¯ä¸ªæœˆçš„è®¢å•æ•°é‡')">
                            ç»Ÿè®¡æ¯ä¸ªæœˆçš„è®¢å•æ•°é‡
                        </div>
                        <div class="example-query" onclick="setQuery('æŸ¥çœ‹é”€å”®é¢æœ€é«˜çš„äº§å“')">
                            æŸ¥çœ‹é”€å”®é¢æœ€é«˜çš„äº§å“
                        </div>
                        <div class="example-query" onclick="setQuery('åˆ†æç”¨æˆ·å¹´é¾„åˆ†å¸ƒ')">
                            åˆ†æç”¨æˆ·å¹´é¾„åˆ†å¸ƒ
                        </div>
                        <div class="example-query" onclick="setQuery('æ˜¾ç¤ºè¿‡å»7å¤©çš„é”€å”®è¶‹åŠ¿')">
                            æ˜¾ç¤ºè¿‡å»7å¤©çš„é”€å”®è¶‹åŠ¿
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <h5><i class="fas fa-database text-info"></i> ç³»ç»Ÿä¿¡æ¯</h5>
                    <div id="systemInfo">
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator status-healthy"></span>
                            <span>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
                        </div>
                        <small class="text-muted">ç‚¹å‡»"ç³»ç»ŸçŠ¶æ€"æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</small>
                    </div>
                </div>
            </div>

            <!-- ä¸»èŠå¤©åŒºåŸŸ -->
            <div class="col-md-9">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3><i class="fas fa-robot me-2"></i>ChatBI æ™ºèƒ½åŠ©æ‰‹</h3>
                        <p class="mb-0">è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘å°†å¸®æ‚¨æŸ¥è¯¢å’Œåˆ†ææ•°æ®</p>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-robot text-primary me-2 mt-1"></i>
                                <div>
                                    <strong>ChatBIåŠ©æ‰‹</strong>
                                    <p class="mb-0 mt-1">æ‚¨å¥½ï¼æˆ‘æ˜¯ChatBIæ™ºèƒ½æ•°æ®æŸ¥è¯¢åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€å‘æˆ‘æé—®ï¼Œæˆ‘ä¼šï¼š</p>
                                    <ul class="mt-2 mb-0">
                                        <li>ğŸ”§ è‡ªåŠ¨ç”ŸæˆSQLæŸ¥è¯¢</li>
                                        <li>ğŸ“Š æ‰§è¡ŒæŸ¥è¯¢å¹¶è·å–æ•°æ®</li>
                                        <li>ğŸ“ˆ æ™ºèƒ½åˆ†ææ•°æ®</li>
                                        <li>ğŸ“‹ è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</li>
                                    </ul>
                                    <p class="mt-2 mb-0">è¯•è¯•å·¦ä¾§çš„ç¤ºä¾‹é—®é¢˜ï¼Œæˆ–è€…ç›´æ¥è¾“å…¥æ‚¨çš„é—®é¢˜å§ï¼</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-section">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="queryInput" 
                                           placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯"
                                           onkeypress="handleKeyPress(event)">
                                    <button class="btn btn-primary btn-lg" onclick="sendQuery()">
                                        <span class="loading spinner-border spinner-border-sm me-1" role="status"></span>
                                        <i class="fas fa-paper-plane"></i> å‘é€
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoVisualize" checked>
                                    <label class="form-check-label" for="autoVisualize">
                                        è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" id="analysisLevel">
                                    <option value="basic">åŸºç¡€åˆ†æ</option>
                                    <option value="standard" selected>æ ‡å‡†åˆ†æ</option>
                                    <option value="detailed">è¯¦ç»†åˆ†æ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»ç»ŸçŠ¶æ€æ¨¡æ€æ¡† -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç³»ç»ŸçŠ¶æ€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statusContent">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è®¾ç½®æŸ¥è¯¢å†…å®¹
        function setQuery(query) {
            document.getElementById('queryInput').value = query;
            document.getElementById('queryInput').focus();
        }

        // å¤„ç†å›è½¦é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuery();
            }
        }

        // å‘é€æŸ¥è¯¢
        async function sendQuery() {
            const input = document.getElementById('queryInput');
            const query = input.value.trim();
            
            if (!query) {
                alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loading = document.querySelector('.loading');
            const button = document.querySelector('.btn-primary');
            loading.classList.add('show');
            button.disabled = true;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©
            addMessage('user', query);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            try {
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const requestData = {
                    question: query,
                    auto_visualize: document.getElementById('autoVisualize').checked,
                    analysis_level: document.getElementById('analysisLevel').value
                };

                // å‘é€è¯·æ±‚
                const response = await fetch('/api/v1/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    displayResult(result);
                } else {
                    addMessage('assistant', `âŒ æŠ±æ­‰ï¼ŒæŸ¥è¯¢å¤±è´¥ï¼š${result.error}`);
                }

            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', `âŒ ç³»ç»Ÿé”™è¯¯ï¼š${error.message}`);
            } finally {
                // éšè—åŠ è½½çŠ¶æ€
                loading.classList.remove('show');
                button.disabled = false;
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="flex-grow-1 text-end">
                            <strong>æ‚¨</strong>
                            <p class="mb-0 mt-1">${content}</p>
                        </div>
                        <i class="fas fa-user text-white ms-2 mt-1"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="fas fa-robot text-primary me-2 mt-1"></i>
                        <div>
                            <strong>ChatBIåŠ©æ‰‹</strong>
                            <div class="mt-1">${content}</div>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        function displayResult(result) {
            let content = '';
            
            // SQLæŸ¥è¯¢
            if (result.sql_query) {
                content += `
                    <div class="mb-3">
                        <h6><i class="fas fa-code text-info"></i> ç”Ÿæˆçš„SQLæŸ¥è¯¢ï¼š</h6>
                        <div class="sql-code">${result.sql_query}</div>
                    </div>
                `;
            }

            // æ•°æ®è¡¨æ ¼
            if (result.data && result.data.length > 0) {
                content += `
                    <div class="mb-3">
                        <h6><i class="fas fa-table text-success"></i> æŸ¥è¯¢ç»“æœ (${result.data.length}è¡Œ)ï¼š</h6>
                        <div class="data-table">
                            ${generateTable(result.data)}
                        </div>
                    </div>
                `;
            }

            // æ•°æ®åˆ†æ
            if (result.analysis) {
                content += `
                    <div class="mb-3">
                        <h6><i class="fas fa-chart-bar text-warning"></i> æ•°æ®åˆ†æï¼š</h6>
                        <div class="analysis-content">${formatAnalysis(result.analysis)}</div>
                    </div>
                `;
            }

            // å›¾è¡¨ä¿¡æ¯
            if (result.chart_info && result.chart_info.success) {
                content += `
                    <div class="mb-3">
                        <h6><i class="fas fa-chart-pie text-primary"></i> æ•°æ®å¯è§†åŒ–ï¼š</h6>
                        <div class="chart-container">
                            <p>å›¾è¡¨å·²ç”Ÿæˆï¼š${result.chart_info.title}</p>
                            <p><small class="text-muted">æ–‡ä»¶è·¯å¾„ï¼š${result.chart_info.file_path}</small></p>
                        </div>
                    </div>
                `;
            }

            // æ‰§è¡Œä¿¡æ¯
            if (result.execution_time) {
                content += `
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> æ‰§è¡Œæ—¶é—´ï¼š${result.execution_time.toFixed(2)}ç§’
                        </small>
                    </div>
                `;
            }

            addMessage('assistant', content);
        }

        // ç”Ÿæˆè¡¨æ ¼HTML
        function generateTable(data) {
            if (!data || data.length === 0) return '<p>æ— æ•°æ®</p>';
            
            const headers = Object.keys(data[0]);
            const maxRows = 10; // æœ€å¤šæ˜¾ç¤º10è¡Œ
            
            let html = '<table class="table table-striped table-sm">';
            html += '<thead class="table-dark"><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.slice(0, maxRows).forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    const value = row[header] !== null && row[header] !== undefined ? row[header] : '';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            if (data.length > maxRows) {
                html += `<p class="text-muted text-center">... è¿˜æœ‰ ${data.length - maxRows} è¡Œæ•°æ®æœªæ˜¾ç¤º</p>`;
            }
            
            return html;
        }

        // æ ¼å¼åŒ–åˆ†æå†…å®¹
        function formatAnalysis(analysis) {
            // ç®€å•çš„markdownåˆ°HTMLè½¬æ¢
            return analysis
                .replace(/### (.*)/g, '<h6 class="text-primary mt-3">$1</h6>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
        async function showSystemStatus() {
            try {
                const response = await fetch('/api/v1/system/status');
                const status = await response.json();
                
                let statusHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ç³»ç»ŸçŠ¶æ€</h6>
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-indicator status-${status.status}"></span>
                                <span>${getStatusText(status.status)}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>æ•°æ®åº“è¿æ¥</h6>
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-indicator ${status.database_connected ? 'status-healthy' : 'status-error'}"></span>
                                <span>${status.database_connected ? 'å·²è¿æ¥' : 'è¿æ¥å¤±è´¥'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Schemaç¼“å­˜</h6>
                            <p>${status.schema_cache_status}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>é…ç½®çŠ¶æ€</h6>
                            <p>${status.config_valid ? 'é…ç½®æœ‰æ•ˆ' : 'é…ç½®æ— æ•ˆ'}</p>
                        </div>
                    </div>
                `;
                
                if (status.warnings && status.warnings.length > 0) {
                    statusHtml += `
                        <div class="mt-3">
                            <h6>è­¦å‘Šä¿¡æ¯</h6>
                            <ul class="list-unstyled">
                                ${status.warnings.map(warning => `<li class="text-warning">âš ï¸ ${warning}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                document.getElementById('statusContent').innerHTML = statusHtml;
                new bootstrap.Modal(document.getElementById('statusModal')).show();
                
            } catch (error) {
                document.getElementById('statusContent').innerHTML = `<p class="text-danger">è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥ï¼š${error.message}</p>`;
                new bootstrap.Modal(document.getElementById('statusModal')).show();
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch (status) {
                case 'healthy': return 'å¥åº·';
                case 'warning': return 'è­¦å‘Š';
                case 'error': return 'é”™è¯¯';
                default: return 'æœªçŸ¥';
            }
        }

        // æ˜¾ç¤ºAPIæ–‡æ¡£
        function showDocs() {
            window.open('/docs', '_blank');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè·å–ç³»ç»ŸçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆå§‹åŒ–ä»£ç 
        });
    </script>
</body>
</html> 