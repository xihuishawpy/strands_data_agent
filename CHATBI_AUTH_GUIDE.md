# ChatBI 认证版使用指南

## 概述

ChatBI 认证版是一个集成了用户认证和权限管理的智能数据查询系统。它在原有ChatBI功能基础上，增加了完整的用户管理、权限控制和安全审计功能。

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面      │    │   认证中间件    │    │   权限管理      │
│  (Gradio Web)   │◄──►│  (Session/Auth) │◄──►│  (Permission)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ChatBI核心    │    │   数据库连接    │    │   审计日志      │
│  (Orchestrator) │◄──►│  (Filtered)     │◄──►│  (Audit Log)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 快速开始

### 1. 启动应用

```bash
# 启动主应用（认证版）
python start_chatbi_auth.py

# 启动管理员界面（可选）
python start_admin_app.py
```

### 2. 访问应用

- **主应用**: http://127.0.0.1:7860
- **管理员界面**: http://127.0.0.1:7861

### 3. 首次使用

1. **管理员设置**（如果是首次部署）：
   - 访问管理员界面
   - 使用管理员账户登录
   - 添加允许注册的工号到白名单

2. **用户注册**：
   - 在主应用的"用户认证"标签页注册账户
   - 工号必须在管理员设置的白名单中
   - 填写必要的用户信息

3. **开始使用**：
   - 注册成功后登录系统
   - 在"智能查询"标签页进行数据查询

## 功能详解

### 🔐 用户认证功能

#### 用户注册
- **工号验证**: 只有在白名单中的工号才能注册
- **密码安全**: 支持密码强度检查和加密存储
- **信息完善**: 支持邮箱、姓名等可选信息

#### 用户登录
- **会话管理**: 自动创建和管理用户会话
- **超时控制**: 会话超时自动登出
- **多设备支持**: 支持同一用户多设备登录

#### 安全特性
- **密码加密**: 使用bcrypt加密存储密码
- **会话令牌**: 使用安全的会话令牌机制
- **权限验证**: 每次操作都进行权限验证

### 🛡️ 权限管理功能

#### Schema级权限控制
- **读取权限**: 只能执行SELECT查询
- **写入权限**: 可以执行INSERT、UPDATE、DELETE操作
- **管理权限**: 拥有完全访问权限，包括DDL操作

#### 动态权限过滤
- **SQL过滤**: 自动过滤用户无权访问的表和字段
- **Schema过滤**: 只显示用户有权限的数据库schema
- **结果过滤**: 查询结果自动按权限过滤

#### 权限继承
- **管理员权限**: 管理员自动继承所有权限
- **默认权限**: 新用户自动获得配置的默认权限
- **公共权限**: 所有用户都能访问的公共schema

### 💬 智能查询功能

#### 自然语言查询
- **语义理解**: 理解自然语言查询意图
- **SQL生成**: 自动生成对应的SQL查询
- **权限检查**: 生成的SQL自动符合用户权限

#### 流式响应
- **实时反馈**: 查询过程实时显示进度
- **步骤展示**: 详细展示每个处理步骤
- **错误提示**: 友好的错误信息和建议

#### 智能分析
- **数据分析**: 自动分析查询结果
- **趋势识别**: 识别数据中的趋势和模式
- **洞察提取**: 提供有价值的数据洞察

### 📊 数据可视化

#### 自动图表生成
- **图表推荐**: 根据数据特征推荐合适的图表类型
- **交互式图表**: 支持缩放、筛选等交互操作
- **多种图表**: 支持柱状图、折线图、散点图等

#### 可视化配置
- **自定义样式**: 支持图表样式自定义
- **导出功能**: 支持图表导出为图片
- **响应式设计**: 适配不同屏幕尺寸

### 📝 反馈和优化

#### 查询反馈
- **点赞功能**: 对满意的查询结果点赞
- **反馈描述**: 提供详细的反馈描述
- **知识积累**: 反馈用于改进系统性能

#### 查询优化
- **历史记录**: 保存查询历史和结果
- **性能监控**: 监控查询执行时间
- **缓存机制**: 缓存常用查询结果

## 管理员功能

### 👥 用户管理
- **用户列表**: 查看所有注册用户
- **用户搜索**: 按工号、邮箱、姓名搜索
- **状态管理**: 启用/禁用用户账户
- **信息查看**: 查看用户详细信息

### 🔑 权限管理
- **权限分配**: 为用户分配schema权限
- **权限撤销**: 撤销用户的特定权限
- **权限查看**: 查看用户的所有权限
- **批量操作**: 支持批量权限操作

### 📋 白名单管理
- **工号添加**: 添加允许注册的工号
- **工号移除**: 移除不再允许的工号
- **描述管理**: 为工号添加描述信息
- **批量导入**: 支持批量导入工号

### 📊 系统统计
- **用户统计**: 总用户数、活跃用户数等
- **权限统计**: 权限分配情况统计
- **使用统计**: 系统使用情况分析
- **实时监控**: 实时系统状态监控

## 安全最佳实践

### 🔒 密码安全
- **强密码策略**: 要求使用强密码
- **定期更换**: 建议定期更换密码
- **加密存储**: 密码使用bcrypt加密存储
- **历史检查**: 防止重复使用历史密码

### 🛡️ 权限控制
- **最小权限原则**: 只分配必要的最小权限
- **定期审查**: 定期审查和清理权限
- **职责分离**: 避免单个用户拥有过多权限
- **权限继承**: 合理设置权限继承规则

### 📋 审计日志
- **操作记录**: 记录所有用户操作
- **权限变更**: 记录权限分配和撤销
- **登录日志**: 记录用户登录和登出
- **异常监控**: 监控异常操作和安全事件

### 🔐 会话安全
- **超时机制**: 设置合理的会话超时时间
- **令牌安全**: 使用安全的会话令牌
- **多设备管理**: 管理用户的多设备会话
- **强制登出**: 支持管理员强制用户登出

## 故障排除

### 常见问题

#### 1. 无法注册账户
**问题**: 提示"工号不在允许列表中"
**解决**: 联系管理员将工号添加到白名单

#### 2. 登录失败
**问题**: 工号和密码正确但无法登录
**解决**: 
- 检查账户是否被禁用
- 确认密码是否正确
- 联系管理员检查账户状态

#### 3. 查询权限不足
**问题**: 查询时提示"权限不足"
**解决**: 
- 检查是否有对应schema的访问权限
- 联系管理员分配相应权限
- 确认查询的表是否在权限范围内

#### 4. 无法访问某些数据
**问题**: 查询结果为空或不完整
**解决**: 
- 确认对相关schema有读取权限
- 检查数据是否确实存在
- 联系管理员确认权限配置

### 错误代码

| 错误代码 | 描述 | 解决方案 |
|---------|------|----------|
| AUTH_001 | 用户不存在 | 检查工号是否正确或先注册 |
| AUTH_002 | 密码错误 | 确认密码或重置密码 |
| AUTH_003 | 账户被禁用 | 联系管理员启用账户 |
| PERM_001 | 权限不足 | 联系管理员分配权限 |
| PERM_002 | Schema访问被拒绝 | 检查schema权限配置 |
| SESS_001 | 会话过期 | 重新登录系统 |
| SESS_002 | 会话无效 | 清除浏览器缓存后重新登录 |

## 技术支持

### 联系方式
- **技术支持**: 联系系统管理员
- **问题反馈**: 通过系统内反馈功能
- **紧急情况**: 联系IT部门

### 系统要求
- **浏览器**: Chrome 80+, Firefox 75+, Safari 13+
- **网络**: 稳定的网络连接
- **分辨率**: 1024x768 或更高

### 更新日志
查看系统更新和新功能发布信息，请关注系统公告或联系管理员。

---

**版本**: 1.0.0  
**更新时间**: 2024年  
**文档维护**: ChatBI开发团队